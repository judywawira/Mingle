<!DOCTYPE html>
<html>
  <head>
    <title>Mingle dashboard</title>
    <link rel="stylesheet" href="style/main.css" type="text/css">
    <link rel="shortcut icon" href="favicon.ico">
  </head>
  <body>
    <a target="_blank" href="http://github.com/thedod/Mingle#readme"><img id="github-ribbon" src="img/github-ribbon.png" alt="Fork me on GitHub"></a>
    <div id="account"></div>

    <div id="header">
      <span id="logo"><img width=32 height=32 src="img/mingle.gif" alt="logo">Mingle</span>
      Dashboard
      <div id="branding"><script language="javascript" src="/mingle/_design/customize/branding.js"></script></div>
    </div>
    <div id="onlyssl">
      <h3>Warning: only use this via ssl to a server you own or trust (personally know the admin)</h3>
    </div>
    <div id="dashboard" style="display:none">
      <h3>Note: only use this via ssl to a server you own or trust (personally know the admin)</h3>
      This is just a rough tweak, and the perfect script-kiddy honey-pot :)
      <h4>Local admin tools</h4>
      You should be logged in as an admin on this server.
      Login via <a target="_blank" href="/_utils">futon</a> if you're not (then refresh this page).<br>
      <ul>
        <li>You can check <a target="_blank" href="/_utils/status.html">replication status</a>.</li>
        <li>
          Sometimes, the easiest way to cancel all replications is to
          <button id="restart">restart the server</button> :)
        </li>
      </ul>
      <h4>Push-replicate to your own mingle server</h4>
      <p>Requires admin credentials at the target server
         (if you don't know <em>this</em> server's owner, <strong>don't</strong> disclose them here):</p>
      replicate <code>mingle</code> to
      https://<input id="user" name="user" size="10" value="you">:<input size="10" type="password" id="password"
        name="password" placeholder="password">@<input id="host" name="host" value="yourserver.iriscouch.com"
      >/<input size="10" id="db" name="db" value="mingle">/
      <br>
      <button id="replicate">Replicate</button>
      <br>
      Notes on replication:
      <ul>
        <li>Traget db should exist and contain the <code>_design/mingle</code>
            (an optionally <code>_design/customize</code>) docs. Replication via this page should filter out code
            (but don't trust this server. We might be evil).</li>
        <li>The right way to do this is via <em>pull</em> replication, but at the moment there's a bug
            that kills continuous pull replications, so this patch is only relevant for a signle person
            (or a group of close friends) owning all servers.</li>
      </ul>
    </div>

  <script type="text/javascript" charset="utf-8" src="js/util.js"></script>
  <script type="text/javascript" charset="utf-8" src="vendor/couchapp/loader.js"></script>
  <script type="text/javascript" charset="utf-8" src="https://browserid.org/include.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/twitter-text.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/domModal.jquery.js"></script>
  <link rel="stylesheet" href="style/domModal.css" type="text/css">
  <script type="text/javascript" charset="utf-8">
    $(function() {
      if (location.protocol.toLowerCase()==="https:") {
          $('#onlyssl').hide();
          $('#replicate').click(function() {
              var urlpref='https://'+$('#user').attr('value')+':',
                  urlsuff='@'+$('#host').attr('value')+'/'+$('#db').attr('value')+'/';
              if (confirm('Continuously replicate to "'+urlpref+'****'+urlsuff+'"?')) {
                $.ajax({
                  type:"POST",dataType:"json",contentType:"application/json",
                  url:"/_replicate",
                  data: // need to serialize this better. Later
                    '{"source":"mingle","continuous":true,"filter":"mingle/nocode",'+
                    '"target":"'+urlpref+$('#password').attr('value')+urlsuff+'"}',
                  complete:function(res,stat){
                      alert('Replication '+stat+': '+res.responseText);
                  }
                });
              }
          });
          $('#restart').click(function() {
              if (confirm('Are you sure?')) {
                $.ajax({
                  type:"POST",dataType:"json",contentType:"application/json",
                  url:"/_restart",
                  complete:function(res,stat){
                    alert('Restart '+stat+': '+res.responseText);
                  }
                });
              }
          });
          $('#dashboard').show();
      };
    });
    var opts = {db:"mingle",design:"mingle"};
    // CHANGE THIS if db or design doc are NOT called mingle. Kludge explained at
    // http://permalink.gmane.org/gmane.comp.db.couchdb.couchapp.general/488
    $.couch.app(function(app) {
      $("#account").evently("account", app);
    },opts);
  </script>
</html>
